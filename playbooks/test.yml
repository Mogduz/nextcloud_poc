- name: base_test
  hosts: owncloud
  gather_facts: true
  remote_user: root
  pre_tasks:
    - name: load host deployment congfig for host "{{ inventory_hostname }}"
      ansible.builtin.include_vars:
        file: "{{ vars_dir }}/hosts/{{ inventory_hostname }}.yml"
        name: host_cfg

    - name: initiate new roles list
      ansible.builtin.set_fact:
        dyn_roles: []

    - name: normalize roles
      ansible.builtin.set_fact:
        dyn_roles: "{{ dyn_roles + [ (item if (item is mapping) else {'name': item}) ] }}"
      loop: "{{ (host_cfg.deployment.roles | default([], true)) }}"
      loop_control:
        label: "{{ (item.name if (item is mapping and 'name' in item) else item) }}"
    
  tasks:
    - name: debug
      debug:
        var: host_cfg

    - name: running deployment roles
      ansible.builtin.include_role:
        name: "{{ item.name }}"
      loop: "{{ dyn_roles }}"
      when: (dyn_roles | length > 0) and (item.when | default(true))
      loop_control:
        label: "{{ item.name }}"
  #roles:
  #  - ufw
  #  - php

    #- name: set domain as hostname
    #  include_tasks: "{{ tasks_dir }}/set_hostname/{{ os_dir }}/main.yml"
    #  vars:
    #    hostname: "{{ domain }}"

    #- name: update system
    #  include_tasks: "{{ tasks_dir }}/update_system/{{ os_dir }}/main.yml"
    #  vars:
    #    reboot_enabled: "{{ upgrade_reboot }}"

  vars:
    domain: "testcloud.leikam-barz.de"
    check_hostname: true
    upgrade_reboot: true